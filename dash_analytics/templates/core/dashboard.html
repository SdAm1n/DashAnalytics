{% extends "base.html" %} {% block title %} Dashboard - Dash Analytics
{%endblock%} {% block content %}
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
    <!-- Stats Cards -->
    <div
        class="bg-white dark:bg-gray-800 shadow rounded-lg p-4 transition-all hover:shadow-lg"
    >
        <div class="flex items-center">
            <div class="flex-shrink-0 bg-blue-500 rounded-md p-3">
                <i class="fas fa-users text-white text-xl"></i>
            </div>
            <div class="ml-4">
                <h2
                    class="text-gray-600 dark:text-gray-400 text-sm font-medium"
                >
                    Total Customers
                </h2>
                <p
                    class="text-2xl font-bold text-gray-900 dark:text-gray-100 customers-count"
                >
                    <span class="loading-placeholder">--</span>
                </p>
            </div>
        </div>
        <div class="mt-3 text-sm text-gray-500 dark:text-gray-400">
            <span class="customer-growth text-green-500"
                ><i class="fas fa-arrow-up"></i> 0%</span
            >
            from last month
        </div>
    </div>

    <div
        class="bg-white dark:bg-gray-800 shadow rounded-lg p-4 transition-all hover:shadow-lg"
    >
        <div class="flex items-center">
            <div class="flex-shrink-0 bg-green-500 rounded-md p-3">
                <i class="fas fa-box text-white text-xl"></i>
            </div>
            <div class="ml-4">
                <h2
                    class="text-gray-600 dark:text-gray-400 text-sm font-medium"
                >
                    Total Products
                </h2>
                <p
                    class="text-2xl font-bold text-gray-900 dark:text-gray-100 products-count"
                >
                    <span class="loading-placeholder">--</span>
                </p>
            </div>
        </div>
        <div class="mt-3 text-sm text-gray-500 dark:text-gray-400">
            <span class="product-growth text-green-500"
                ><i class="fas fa-arrow-up"></i> 0%</span
            >
            from last month
        </div>
    </div>

    <div
        class="bg-white dark:bg-gray-800 shadow rounded-lg p-4 transition-all hover:shadow-lg"
    >
        <div class="flex items-center">
            <div class="flex-shrink-0 bg-purple-500 rounded-md p-3">
                <i class="fas fa-shopping-cart text-white text-xl"></i>
            </div>
            <div class="ml-4">
                <h2
                    class="text-gray-600 dark:text-gray-400 text-sm font-medium"
                >
                    Total Orders
                </h2>
                <p
                    class="text-2xl font-bold text-gray-900 dark:text-gray-100 orders-count"
                >
                    <span class="loading-placeholder">--</span>
                </p>
            </div>
        </div>
        <div class="mt-3 text-sm text-gray-500 dark:text-gray-400">
            <span class="orders-growth text-green-500"
                ><i class="fas fa-arrow-up"></i> 0%</span
            >
            from last month
        </div>
    </div>

    <div
        class="bg-white dark:bg-gray-800 shadow rounded-lg p-4 transition-all hover:shadow-lg"
    >
        <div class="flex items-center">
            <div class="flex-shrink-0 bg-yellow-500 rounded-md p-3">
                <i class="fas fa-dollar-sign text-white text-xl"></i>
            </div>
            <div class="ml-4">
                <h2
                    class="text-gray-600 dark:text-gray-400 text-sm font-medium"
                >
                    Total Revenue
                </h2>
                <p
                    class="text-2xl font-bold text-gray-900 dark:text-gray-100 revenue-total"
                >
                    <span class="loading-placeholder">--</span>
                </p>
            </div>
        </div>
        <div class="mt-3 text-sm text-gray-500 dark:text-gray-400">
            <span class="revenue-growth text-green-500"
                ><i class="fas fa-arrow-up"></i> 0%</span
            >
            from last month
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-8">
    <!-- Sales Trend Chart -->
    <div
        class="bg-white dark:bg-gray-800 shadow rounded-lg p-4 transition-all hover:shadow-lg"
    >
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-medium text-gray-900 dark:text-gray-100">
                Sales Trend
            </h2>
            <div class="flex space-x-2">
                <button
                    class="period-button px-2 py-1 text-xs rounded focus:outline-none focus:ring-2 focus:ring-blue-500 bg-blue-600 text-white"
                    data-period="week"
                >
                    Week
                </button>
                <button
                    class="period-button px-2 py-1 text-xs rounded focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600"
                    data-period="month"
                >
                    Month
                </button>
                <button
                    class="period-button px-2 py-1 text-xs rounded focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600"
                    data-period="year"
                >
                    Year
                </button>
            </div>
        </div>
        <div class="h-64 relative">
            <div
                class="absolute inset-0 flex items-center justify-center sales-chart-loader"
            >
                <div
                    class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"
                ></div>
            </div>
            <canvas id="salesTrendChart"></canvas>
        </div>
    </div>

    <!-- Top Products Chart -->
    <div
        class="bg-white dark:bg-gray-800 shadow rounded-lg p-4 transition-all hover:shadow-lg"
    >
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-medium text-gray-900 dark:text-gray-100">
                Top Products
            </h2>
            <select
                id="topProductsLimit"
                class="text-xs rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 focus:ring-blue-500 focus:border-blue-500"
            >
                <option value="5">Top 5</option>
                <option value="10">Top 10</option>
                <option value="15">Top 15</option>
            </select>
        </div>
        <div class="h-64 relative">
            <div
                class="absolute inset-0 flex items-center justify-center products-chart-loader"
            >
                <div
                    class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"
                ></div>
            </div>
            <canvas id="topProductsChart"></canvas>
        </div>
    </div>
</div>

<!-- Customer Demographics & Geographic Insight Preview -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-8">
    <!-- Customer Demographics Chart -->
    <div
        class="bg-white dark:bg-gray-800 shadow rounded-lg p-4 transition-all hover:shadow-lg"
    >
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-medium text-gray-900 dark:text-gray-100">
                Customer Demographics
            </h2>
            <a
                href="{% url 'demographics' %}"
                class="text-blue-600 hover:text-blue-800 text-sm"
            >
                View Details
                <i class="fas fa-arrow-right ml-1"></i>
            </a>
        </div>
        <div class="h-64 relative">
            <div
                class="absolute inset-0 flex items-center justify-center demographics-chart-loader"
            >
                <div
                    class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"
                ></div>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="text-center">
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                        Gender Ratio
                    </p>
                    <div
                        id="genderRatioMetric"
                        class="text-xl font-bold text-gray-900 dark:text-gray-100"
                    >
                        --
                    </div>
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                        Most Active Age
                    </p>
                    <div
                        id="activeAgeMetric"
                        class="text-xl font-bold text-gray-900 dark:text-gray-100"
                    >
                        --
                    </div>
                </div>
            </div>
            <div class="h-56">
                <canvas id="demographicsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Geographic Insight Preview -->
    <div
        class="bg-white dark:bg-gray-800 shadow rounded-lg p-4 transition-all hover:shadow-lg"
    >
        <div class="flex flex-col items-center mb-4">
            <h2
                class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-4"
            >
                Geographical Insights
            </h2>
            <a
                href="{% url 'geographical_insights' %}"
                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors duration-200 flex items-center gap-4 shadow-sm hover:shadow-md"
            >
                View Full Report
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M14 5l7 7m0 0l-7 7m7-7H3"
                    />
                </svg>
            </a>
        </div>
        <div class="h-64 relative">
            <div
                class="absolute inset-0 flex items-center justify-center geo-chart-loader"
            >
                <div
                    class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"
                ></div>
            </div>
            <div id="geoInsightsChart" class="h-full"></div>
        </div>
    </div>
</div>
{% endblock %} {% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Chart instances
    let salesTrendChart = null;
    let topProductsChart = null;
    let demographicsChart = null;
    let geoChart = null;

    // Function to format currency
    function formatCurrency(amount) {
        return new Intl.NumberFormat("en-US", {
            style: "currency",
            currency: "USD",
            minimumFractionDigits: 2,
        }).format(amount);
    }

    // Function to format date
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
        });
    }

    // Function to update growth indicators
    function updateGrowthIndicator(element, percentage) {
        if (percentage > 0) {
            element.innerHTML = `<i class="fas fa-arrow-up mr-1"></i> ${percentage}%`;
            element.className = "text-green-500";
        } else if (percentage < 0) {
            element.innerHTML = `<i class="fas fa-arrow-down mr-1"></i> ${Math.abs(
                percentage
            )}%`;
            element.className = "text-red-500";
        } else {
            element.innerHTML = `<i class="fas fa-equals mr-1"></i> ${percentage}%`;
            element.className = "text-gray-500";
        }
    }

    // Function to update charts based on date filter
    function updateChartsWithPeriod(period) {
        fetchSummary(period);
        fetchSalesTrendData(period);
        fetchTopProducts();
        fetchDemographicsData();
        console.log("Updating charts for period:", period);
    }

    // Function to show loading indicators
    function showLoading() {
        document.querySelectorAll(".loading-placeholder").forEach((el) => {
            el.innerText = "--";
        });
        document.querySelector(".sales-chart-loader").style.display = "flex";
        document.querySelector(".products-chart-loader").style.display = "flex";
        document.querySelector(".demographics-chart-loader").style.display =
            "flex";
    }

    // Function to hide loading indicators
    function hideLoading() {
        document.querySelector(".sales-chart-loader").style.display = "none";
        document.querySelector(".products-chart-loader").style.display = "none";
        document.querySelector(".demographics-chart-loader").style.display =
            "none";
    }

    // Fetch summary data for dashboard
    function fetchSummary(period = "all") {
        // Show loading indicators
        document.querySelectorAll(".loading-placeholder").forEach((el) => {
            el.innerText = "--";
        });

        fetch(`/api/analytics/dashboard_summary/?period=${period}`)
            .then((response) => response.json())
            .then((data) => {
                document.querySelector(".customers-count").textContent =
                    data.total_customers ?? "0";
                document.querySelector(".products-count").textContent =
                    data.total_products ?? "0";
                document.querySelector(".orders-count").textContent =
                    data.total_orders ?? "0";
                document.querySelector(".revenue-total").textContent =
                    formatCurrency(data.total_revenue ?? 0);

                // Update growth indicators
                updateGrowthIndicator(
                    document.querySelector(".customer-growth"),
                    data.customer_growth ?? 0
                );
                updateGrowthIndicator(
                    document.querySelector(".product-growth"),
                    data.product_growth ?? 0
                );
                updateGrowthIndicator(
                    document.querySelector(".orders-growth"),
                    data.order_growth ?? 0
                );
                updateGrowthIndicator(
                    document.querySelector(".revenue-growth"),
                    data.revenue_growth ?? 0
                );
            })
            .catch((error) => {
                console.error("Error fetching dashboard summary:", error);

                // Fallback to sample data
                document.querySelector(".customers-count").textContent =
                    "1,245";
                document.querySelector(".products-count").textContent = "456";
                document.querySelector(".orders-count").textContent = "5,678";
                document.querySelector(".revenue-total").textContent =
                    "$348,291.23";

                // Sample growth indicators
                updateGrowthIndicator(
                    document.querySelector(".customer-growth"),
                    12.5
                );
                updateGrowthIndicator(
                    document.querySelector(".product-growth"),
                    8.3
                );
                updateGrowthIndicator(
                    document.querySelector(".orders-growth"),
                    15.2
                );
                updateGrowthIndicator(
                    document.querySelector(".revenue-growth"),
                    18.7
                );
            });
    }

    // Fetch sales trend data
    function fetchSalesTrendData(period = "week") {
        document.querySelector(".sales-chart-loader").style.display = "flex";

        // Update active period button
        document.querySelectorAll(".period-button").forEach((button) => {
            if (button.dataset.period === period) {
                button.classList.remove(
                    "bg-gray-200",
                    "text-gray-700",
                    "dark:bg-gray-700",
                    "dark:text-gray-300"
                );
                button.classList.add("bg-blue-600", "text-white");
            } else {
                button.classList.remove("bg-blue-600", "text-white");
                button.classList.add(
                    "bg-gray-200",
                    "text-gray-700",
                    "dark:bg-gray-700",
                    "dark:text-gray-300"
                );
            }
        });

        // Calculate date range based on period
        const today = new Date();
        let dateFrom = new Date(today);
        switch (period) {
            case "week":
                dateFrom.setDate(today.getDate() - 7);
                break;
            case "month":
                dateFrom.setMonth(today.getMonth() - 1);
                break;
            case "year":
                dateFrom.setFullYear(today.getFullYear() - 1);
                break;
        }

        fetch(
            `/api/analytics/sales_trend/?period=${period}&category=all&date_from=${
                dateFrom.toISOString().split("T")[0]
            }&date_to=${today.toISOString().split("T")[0]}`
        )
            .then((response) => response.json())
            .then((data) => {
                updateSalesTrendChart(data);
                document.querySelector(".sales-chart-loader").style.display =
                    "none";
            })
            .catch((error) => {
                console.error("Error fetching sales trend data:", error);

                // Fallback to sample data with the same format as the sales trend page
                const sampleData = [
                    {
                        period: "2023-01",
                        total_sales: 25000,
                        order_count: 120,
                        total_profit: 5000,
                        total_quantity: 240,
                        growth_rate: 0,
                    },
                    {
                        period: "2023-02",
                        total_sales: 28000,
                        order_count: 135,
                        total_profit: 5600,
                        total_quantity: 270,
                        growth_rate: 12,
                    },
                    {
                        period: "2023-03",
                        total_sales: 29500,
                        order_count: 140,
                        total_profit: 5900,
                        total_quantity: 280,
                        growth_rate: 5.36,
                    },
                    {
                        period: "2023-04",
                        total_sales: 31000,
                        order_count: 150,
                        total_profit: 6200,
                        total_quantity: 300,
                        growth_rate: 5.08,
                    },
                    {
                        period: "2023-05",
                        total_sales: 33000,
                        order_count: 160,
                        total_profit: 6600,
                        total_quantity: 320,
                        growth_rate: 6.45,
                    },
                    {
                        period: "2023-06",
                        total_sales: 35000,
                        order_count: 170,
                        total_profit: 7000,
                        total_quantity: 340,
                        growth_rate: 6.06,
                    },
                ];
                updateSalesTrendChart(sampleData);
                document.querySelector(".sales-chart-loader").style.display =
                    "none";
            });
    }

    // Fetch top products data
    function fetchTopProducts() {
        document.querySelector(".products-chart-loader").style.display = "flex";
        const limit = document.getElementById("topProductsLimit").value || 5;

        fetch(`/api/products/top_sellers/?limit=${limit}`)
            .then((response) => response.json())
            .then((data) => {
                updateTopProductsChart(data);
                document.querySelector(".products-chart-loader").style.display =
                    "none";
            })
            .catch((error) => {
                console.error("Error fetching top products:", error);

                // Fallback to sample data
                const sampleData = [
                    { product_name: "Product A", total_quantity: 240 },
                    { product_name: "Product B", total_quantity: 180 },
                    { product_name: "Product C", total_quantity: 150 },
                    { product_name: "Product D", total_quantity: 120 },
                    { product_name: "Product E", total_quantity: 90 },
                ];
                updateTopProductsChart(sampleData);
                document.querySelector(".products-chart-loader").style.display =
                    "none";
            });
    }

    // Fetch demographics data
    function fetchDemographicsData() {
        document.querySelector(".demographics-chart-loader").style.display =
            "flex";

        fetch("/api/analytics/demographics/?period=1y")
            .then((response) => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then((data) => {
                console.log("Demographics data received:", data);
                updateDemographicsMetrics(data);
                updateDemographicsChart(data.gender_distribution);
                document.querySelector(
                    ".demographics-chart-loader"
                ).style.display = "none";
            })
            .catch((error) => {
                console.error("Error fetching demographics data:", error);
                // Use sample data as fallback
                const sampleData = {
                    gender_distribution: {
                        male: 55,
                        female: 45,
                    },
                    average_age: 34,
                    gender_ratio: 1.22,
                    most_active_age_group: "25-34",
                };
                updateDemographicsMetrics(sampleData);
                updateDemographicsChart(sampleData.gender_distribution);
                document.querySelector(
                    ".demographics-chart-loader"
                ).style.display = "none";
            });
    }

    // Update demographics metrics
    function updateDemographicsMetrics(data) {
        document.getElementById("genderRatioMetric").textContent =
            data.gender_ratio.toFixed(2);
        document.getElementById("activeAgeMetric").textContent =
            data.most_active_age_group;
    }

    // Update demographics chart
    function updateDemographicsChart(data) {
        const ctx = document
            .getElementById("demographicsChart")
            .getContext("2d");
        const isDarkMode = document.documentElement.classList.contains("dark");
        const textColor = isDarkMode ? "#cbd5e0" : "#4a5568";
        const borderColor = isDarkMode ? "#2d3748" : "#e2e8f0";

        if (demographicsChart) {
            demographicsChart.destroy();
        }

        demographicsChart = new Chart(ctx, {
            type: "doughnut",
            data: {
                labels: ["Male", "Female"],
                datasets: [
                    {
                        data: [data.male, data.female],
                        backgroundColor: [
                            "rgba(14, 165, 233, 0.8)",
                            "rgba(236, 72, 153, 0.8)",
                        ],
                        borderColor: ["rgb(14, 165, 233)", "rgb(236, 72, 153)"],
                        borderWidth: 1,
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: "bottom",
                        labels: {
                            color: textColor,
                            padding: 10,
                            boxWidth: 12,
                        },
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const percentage =
                                    Math.round(context.parsed * 10) / 10;
                                return `${context.label}: ${percentage}%`;
                            },
                        },
                    },
                },
            },
        });
    }

    // Update sales trend chart
    function updateSalesTrendChart(data) {
        const ctx = document.getElementById("salesTrendChart").getContext("2d");
        const isDarkMode = document.documentElement.classList.contains("dark");
        const textColor = isDarkMode ? "#cbd5e0" : "#4a5568";
        const gridColor = isDarkMode
            ? "rgba(255,255,255,0.1)"
            : "rgba(0,0,0,0.1)";

        if (salesTrendChart) {
            salesTrendChart.destroy();
        }

        salesTrendChart = new Chart(ctx, {
            type: "line",
            data: {
                labels: data.map((item) => formatDate(item.period)),
                datasets: [
                    {
                        label: "Sales",
                        data: data.map((item) => item.total_sales),
                        backgroundColor: "rgba(59, 130, 246, 0.1)",
                        borderColor: "rgb(59, 130, 246)",
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false,
                    },
                    tooltip: {
                        mode: "index",
                        intersect: false,
                        callbacks: {
                            label: function (context) {
                                return (
                                    "Sales: " + formatCurrency(context.parsed.y)
                                );
                            },
                        },
                    },
                },
                interaction: {
                    intersect: false,
                    mode: "index",
                },
                scales: {
                    x: {
                        grid: {
                            display: false,
                        },
                        ticks: {
                            color: textColor,
                        },
                    },
                    y: {
                        grid: {
                            color: gridColor,
                        },
                        ticks: {
                            color: textColor,
                            callback: function (value) {
                                return formatCurrency(value);
                            },
                        },
                    },
                },
            },
        });
    }

    // Update top products chart
    function updateTopProductsChart(data) {
        const ctx = document
            .getElementById("topProductsChart")
            .getContext("2d");
        const isDarkMode = document.documentElement.classList.contains("dark");
        const textColor = isDarkMode ? "#cbd5e0" : "#4a5568";
        const gridColor = isDarkMode
            ? "rgba(255,255,255,0.1)"
            : "rgba(0,0,0,0.1)";

        if (topProductsChart) {
            topProductsChart.destroy();
        }

        topProductsChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: data.map((item) => item.product_name),
                datasets: [
                    {
                        data: data.map((item) => item.total_quantity),
                        backgroundColor: "rgba(34, 197, 94, 0.8)",
                        borderColor: "rgb(34, 197, 94)",
                        borderWidth: 1,
                    },
                ],
            },
            options: {
                indexAxis: "y",
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false,
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return `Quantity sold: ${context.parsed.x.toLocaleString()}`;
                            },
                        },
                    },
                },
                scales: {
                    x: {
                        grid: {
                            color: gridColor,
                        },
                        ticks: {
                            color: textColor,
                            callback: function (value) {
                                return value.toLocaleString();
                            },
                        },
                    },
                    y: {
                        grid: {
                            display: false,
                        },
                        ticks: {
                            color: textColor,
                        },
                    },
                },
            },
        });
    }

    // Fetch geographical insights data
    function fetchGeographicalData() {
        document.querySelector(".geo-chart-loader").style.display = "flex";

        fetch("/api/analytics/geographical/?period=last-month&region=all")
            .then((response) => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then((data) => {
                console.log("Geographical data received:", data);
                updateGeographicalInsightsChart(data);
                document.querySelector(".geo-chart-loader").style.display =
                    "none";
            })
            .catch((error) => {
                console.error("Error fetching geographical data:", error);
                // Fallback to sample data
                const sampleData = {
                    cities: [
                        {
                            name: "New York",
                            revenue: 1200000,
                        },
                        {
                            name: "London",
                            revenue: 980000,
                        },
                        {
                            name: "Tokyo",
                            revenue: 850000,
                        },
                    ],
                };
                updateGeographicalInsightsChart(sampleData);
                document.querySelector(".geo-chart-loader").style.display =
                    "none";
            });
    }

    // Update geographical insights chart
    function updateGeographicalInsightsChart(data) {
        const ctx = document.getElementById("geoInsightsChart");
        const isDarkMode = document.documentElement.classList.contains("dark");
        const textColor = isDarkMode ? "#cbd5e0" : "#4a5568";
        const gridColor = isDarkMode
            ? "rgba(255,255,255,0.1)"
            : "rgba(0,0,0,0.1)";

        if (geoChart) {
            geoChart.destroy();
        }

        // Sort cities by revenue and take top 5
        const topCities = data.cities
            .sort((a, b) => b.revenue - a.revenue)
            .slice(0, 5);

        geoChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: topCities.map((city) => city.name),
                datasets: [
                    {
                        label: "Revenue",
                        data: topCities.map((city) => city.revenue),
                        backgroundColor: "rgba(59, 130, 246, 0.8)",
                        borderColor: "rgb(59, 130, 246)",
                        borderWidth: 1,
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false,
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const value = context.parsed.y;
                                return `Revenue: $${value.toLocaleString()}`;
                            },
                        },
                    },
                },
                scales: {
                    x: {
                        grid: {
                            display: false,
                        },
                        ticks: {
                            color: textColor,
                        },
                    },
                    y: {
                        grid: {
                            color: gridColor,
                        },
                        ticks: {
                            color: textColor,
                            callback: function (value) {
                                return "$" + (value / 1000).toFixed(0) + "k";
                            },
                        },
                    },
                },
            },
        });
    }

    // Recent Orders table functionality has been removed

    // Initialize charts on page load
    document.addEventListener("DOMContentLoaded", function () {
        // Show loading indicators
        showLoading();

        // Initialize all charts and data
        fetchSummary();
        fetchSalesTrendData("week");
        fetchTopProducts();
        fetchDemographicsData();
        fetchGeographicalData();

        // Setup event listeners for period buttons
        document.querySelectorAll(".period-button").forEach((button) => {
            button.addEventListener("click", function () {
                const period = this.dataset.period;
                fetchSalesTrendData(period);
            });
        });

        // Setup event listener for top products limit dropdown
        document
            .getElementById("topProductsLimit")
            .addEventListener("change", function () {
                fetchTopProducts();
            });

        // Handle dark mode changes to update chart colors
        const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                if (mutation.attributeName === "class") {
                    const isDarkMode =
                        document.documentElement.classList.contains("dark");
                    if (window.salesTrendChart) {
                        fetchSalesTrendData(
                            document.querySelector(".period-button.bg-blue-600")
                                .dataset.period
                        );
                    }
                    if (window.topProductsChart) {
                        fetchTopProducts();
                    }
                    if (window.demographicsChart) {
                        fetchDemographicsData();
                    }
                    if (window.topCitiesChart) {
                        fetchGeographicalData();
                    }
                }
            });
        });

        observer.observe(document.documentElement, { attributes: true });
    });
</script>
{% endblock %}
